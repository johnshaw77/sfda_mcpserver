# 模擬資料到實際資料庫遷移指南

2026-06-15

## 概述

本文件提供從模擬資料轉換到實際資料庫的系統性方法，採用「一張表一張表、一個服務一個服務」的漸進式遷移策略。

## 遷移流程

### 1. 選定目標資料表

- 選擇一個適合優先遷移的資料表
- 考慮因素：
  - 業務重要性
  - 使用頻率
  - 複雜度（先從較簡單的表開始）
  - 與其他表的依賴關係（盡量先處理被依賴的表）

### 2. 分析資料表結構與業務需求

- 詳細記錄表的結構：

  ```
  資料表名稱：[表名]
  主鍵：[主鍵欄位]
  欄位列表：
  - [欄位名稱]：[資料類型]，[描述]，[約束條件]
  - ...
  索引：
  - [索引名稱]：[欄位]，[類型]
  - ...
  ```

- 識別該表的業務用途：

  - 主要功能
  - 關聯的業務流程
  - 與其他表的關係

- 確認查詢模式：
  - 常用查詢類型
  - 查詢頻率
  - 性能要求

### 3. 建立對應的服務層

- 創建服務文件：

  ```javascript
  /**
   * [表名] 資料服務
   *
   * 提供與 [表名] 相關的資料庫操作功能
   *
   * 資料庫欄位映射:
   * - [DB欄位名稱] -> [中文說明]
   * - ...
   */
  ```

- 實現基本的 CRUD 操作：

  - 查詢單筆資料
  - 查詢多筆資料（支援過濾與分頁）
  - 新增資料（如適用）
  - 更新資料（如適用）
  - 刪除資料（如適用）

- 實現業務邏輯方法：

  - 根據業務需求實現特定方法
  - 確保方法名稱清晰表達其功能

- 加入完善的錯誤處理：

  - 捕獲並記錄所有可能的錯誤
  - 提供有意義的錯誤訊息
  - 適當地轉換或傳遞錯誤

- 加入詳細的日誌記錄：
  - 記錄方法調用
  - 記錄查詢參數
  - 記錄執行結果
  - 記錄錯誤情況

### 4. 調整/建立相關工具

- 識別使用該表的所有工具：

  ```
  工具列表：
  - [工具名稱]：[功能描述]
  - ...
  ```

- 修改每個工具：

  - 更新參數名稱與說明，使之與資料庫欄位一致
  - 移除模擬資料生成邏輯
  - 改為調用服務層方法
  - 保持工具參數結構和返回格式穩定（除非必須變更）

- 確保文檔一致性：
  - 更新工具說明
  - 更新參數描述
  - 更新範例值

### 5. 測試與驗證

- 單元測試：

  - 測試服務層各方法
  - 覆蓋常見場景和邊界情況
  - 測試錯誤處理

- 整合測試：

  - 測試工具與服務的交互
  - 驗證與實際資料庫的連接
  - 測試完整流程

- 性能測試（如需要）：
  - 測試查詢性能
  - 識別潛在瓶頸
  - 實施必要的優化

### 6. 文檔與知識庫更新

- 更新開發文檔：

  - 記錄新服務的用途和方法
  - 說明參數變更
  - 提供使用範例

- 更新 API 文檔：

  - 修改工具描述
  - 更新參數說明
  - 更新返回值格式

- 記錄遷移過程：
  - 記錄遇到的問題和解決方案
  - 記錄重要決策及其理由
  - 提供給未來遷移工作參考

### 7. 進行下一個表的遷移

- 選擇下一個要遷移的表
- 重複以上步驟
- 優先考慮與已遷移表有關聯的表

## 實際案例：org_employee 表遷移

### 1. 選定資料表

- 表名：`org_employee`
- 優先原因：員工資料是 HR 系統的基礎，多個功能依賴此表

### 2. 分析表結構

```
資料表名稱：org_employee
主鍵：employee_no
欄位列表：
- employee_no：VARCHAR(50)，員工編號
- name：VARCHAR(100)，姓名
- nickname：VARCHAR(100)，別名（英文名）
- group_name：VARCHAR(100)，部門名稱
- group_code：VARCHAR(50)，部門代碼
- email：VARCHAR(100)，電子郵件
- is_suspended：BOOLEAN，是否停用
- last_suspended_date：DATETIME，停用時間
- user_type：VARCHAR(50)，用戶類型
- domain：VARCHAR(50)，AD Domain
- account：VARCHAR(100)，AD 帳號
- lang：VARCHAR(20)，語系
- address：VARCHAR(200)，住址
- arrive_date：DATE，到職日期
- leave_date：DATE，離職日期
- birthday：DATE，生日
- sex：VARCHAR(10)，性別
- telphone：VARCHAR(50)，公司電話
- ext_num：VARCHAR(20)，公司桌機
- mobile：VARCHAR(50)，手機
- title_name：VARCHAR(100)，職位名稱
```

### 3. 建立服務層

- 創建文件：`/services/hr/employee-service.js`
- 實現方法：
  - `getEmployeeById`: 查詢單個員工資料
  - `getEmployeeList`: 查詢員工列表
  - `findEmployeesByNameOrDepartment`: 依姓名或部門查詢員工

### 4. 調整工具

- 修改 `get-employee-info.js`：

  - 參數名稱從 `employeeId` 改為 `employeeNo`
  - 移除模擬資料邏輯
  - 改為調用 `employeeService.getEmployeeById`

- 修改 `get-employee-list.js`：

  - 參數名稱從 `jobTitle` 改為 `titleName`
  - 改為調用 `employeeService.getEmployeeList`

- 修改 `get-employee-id.js`：

  - 確保參數名稱與資料庫一致
  - 改為調用 `employeeService.findEmployeesByNameOrDepartment`

- 修改 `get-attendance-record.js` 和 `get-salary-info.js`：
  - 參數名稱從 `employeeId` 改為 `employeeNo`

### 5. 測試與驗證

- 測試各工具與實際資料庫的交互
- 驗證錯誤處理機制
- 檢查返回格式是否符合預期

### 6. 文檔更新

- 更新 README.md
- 更新工具說明和範例

## 注意事項

### 命名規範

- 資料庫欄位名稱使用 snake_case（如 `employee_no`）
- JavaScript 變數使用 camelCase（如 `employeeNo`）
- 確保轉換時的一致性

### 錯誤處理

- 捕獲並記錄所有資料庫錯誤
- 提供清晰的錯誤訊息給呼叫者
- 避免在生產環境暴露敏感的錯誤詳情

### 效能考量

- 只查詢必要的欄位
- 適當使用索引
- 考慮分頁查詢大量資料
- 監控查詢性能

### 安全性

- 防止 SQL 注入
- 控制敏感資料的訪問
- 記錄敏感操作

## 結論

遵循本指南的「一張表一張表、一個服務一個服務」漸進式遷移策略，可以確保系統從模擬資料平穩過渡到實際資料庫。每完成一個表的遷移即達成一個明確里程碑，整個過程可控、可測試且風險可控。

# Prometheus 告警規則
# MCP Server 監控告警配置

groups:
  - name: mcp-server-alerts
    rules:
      # 服務健康檢查
      - alert: MCPServerDown
        expr: up{job="mcp-server"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MCP Server 服務停止"
          description: "MCP Server 已停止運行超過 1 分鐘"

      # 高錯誤率告警
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "MCP Server 錯誤率過高"
          description: "過去 5 分鐘內錯誤率超過 10%"

      # 高回應時間告警
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "MCP Server 回應時間過長"
          description: "95% 的請求回應時間超過 1 秒"

      # 記憶體使用過高
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "系統記憶體使用率過高"
          description: "記憶體使用率超過 85%"

      # CPU 使用過高
      - alert: HighCPUUsage
        expr: 100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "系統 CPU 使用率過高"
          description: "CPU 使用率超過 80%"

  - name: tool-specific-alerts
    rules:
      # 工具調用失敗率過高
      - alert: ToolHighFailureRate
        expr: rate(tool_calls_total{status="error"}[5m]) / rate(tool_calls_total[5m]) > 0.2
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "工具調用失敗率過高"
          description: "{{ $labels.tool_name }} 工具過去 5 分鐘失敗率超過 20%"

      # SSE 連接異常
      - alert: SSEConnectionDrop
        expr: decrease(sse_connections_total[10m]) > 10
        for: 1m
        labels:
          severity: info
        annotations:
          summary: "SSE 連接大量斷開"
          description: "過去 10 分鐘內超過 10 個 SSE 連接斷開"
